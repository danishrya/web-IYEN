// Ini menunjukkan cara integrate fungsi-fungsi baru

"use client"

import { useState, useRef, useEffect } from "react"
import { ChatMessage } from "@/components/chat-message"
import { ChatInput } from "@/components/chat-input"
import { sendChatMessage } from "@/app/actions/chat"
import { generateSuggestions, formatTimeStamp } from "@/components/chat-utils"
import { useChatHistory } from "@/components/chat-hooks"
import { RotateCcw, Clock } from "lucide-react"

interface Message {
  id: string
  role: "user" | "assistant"
  content: string
  timestamp: Date // tambah timestamp
}

export default function ChatPageEnhanced() {
  const [messages, setMessages] = useState<Message[]>([
    {
      id: "1",
      role: "assistant",
      content: "Halo! Saya adalah assistant untuk Eco-build Check. Ada yang bisa saya bantu?",
      timestamp: new Date(),
    },
  ])
  const [isLoading, setIsLoading] = useState(false)
  const [suggestions, setSuggestions] = useState<string[]>([]) // suggestion system
  const messagesEndRef = useRef<HTMLDivElement>(null)
  const { history, addToHistory } = useChatHistory() // pakai custom hook

  const formatMessageTime = (date: Date): string => {
    return formatTimeStamp(date)
  }

  const updateSuggestions = (lastMessage: string) => {
    const newSuggestions = generateSuggestions(lastMessage)
    setSuggestions(newSuggestions)
  }

  const handleSuggestionClick = async (suggestion: string) => {
    const userMessage: Message = {
      id: Date.now().toString(),
      role: "user",
      content: suggestion,
      timestamp: new Date(),
    }

    setMessages((prev) => [...prev, userMessage])
    addToHistory(suggestion)
    setIsLoading(true)

    try {
      const response = await sendChatMessage([
        ...messages.map((m) => ({
          role: m.role,
          content: m.content,
        })),
        { role: "user", content: suggestion },
      ])

      const assistantMessage: Message = {
        id: (Date.now() + 1).toString(),
        role: "assistant",
        content: response,
        timestamp: new Date(),
      }

      setMessages((prev) => [...prev, assistantMessage])
      updateSuggestions(response)
    } catch (error) {
      console.error("[v0] Error:", error)
    } finally {
      setIsLoading(false)
    }
  }

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" })
  }

  useEffect(() => {
    scrollToBottom()
  }, [messages])

  const exportChat = () => {
    const chatText = messages
      .map((m) => `[${formatMessageTime(m.timestamp)}] ${m.role.toUpperCase()}: ${m.content}`)
      .join("\n\n")

    const element = document.createElement("a")
    element.setAttribute("href", "data:text/plain;charset=utf-8," + encodeURIComponent(chatText))
    element.setAttribute("download", `chat-${new Date().getTime()}.txt`)
    element.style.display = "none"
    document.body.appendChild(element)
    element.click()
    document.body.removeChild(element)
  }

  const handleNewChat = () => {
    setMessages([
      {
        id: "1",
        role: "assistant",
        content: "Halo! Saya adalah assistant untuk Eco-build Check. Ada yang bisa saya bantu?",
        timestamp: new Date(),
      },
    ])
    setSuggestions([])
  }

  return (
    <div className="flex flex-col h-full bg-gradient-to-br from-slate-50 via-white to-slate-50">
      {/* ... existing header ... */}

      <div className="flex-1 overflow-y-auto p-6">
        <div className="max-w-2xl mx-auto">
          {messages.map((message) => (
            <div key={message.id}>
              <div className="text-xs text-slate-500 mb-1 px-1">
                <Clock className="w-3 h-3 inline mr-1" />
                {formatMessageTime(message.timestamp)}
              </div>
              <ChatMessage role={message.role} content={message.content} />
            </div>
          ))}

          {suggestions.length > 0 && !isLoading && (
            <div className="mt-6 mb-4">
              <p className="text-sm text-slate-600 mb-2">Pertanyaan yang bisa diajukan:</p>
              <div className="grid gap-2">
                {suggestions.map((suggestion, idx) => (
                  <button
                    key={idx}
                    onClick={() => handleSuggestionClick(suggestion)}
                    className="text-left p-3 rounded-lg border border-green-200 bg-green-50 hover:bg-green-100 text-slate-700 text-sm transition-colors"
                  >
                    {suggestion}
                  </button>
                ))}
              </div>
            </div>
          )}

          {isLoading && <ChatMessage role="assistant" content="" isLoading={true} />}
          <div ref={messagesEndRef} />
        </div>
      </div>

      <div className="bg-gradient-to-t from-white to-transparent border-t border-slate-200 p-6">
        <div className="max-w-2xl mx-auto flex gap-2">
          <ChatInput
            onSend={async (text) => {
              const userMessage: Message = {
                id: Date.now().toString(),
                role: "user",
                content: text,
                timestamp: new Date(),
              }
              setMessages((prev) => [...prev, userMessage])
              addToHistory(text)
              setIsLoading(true)

              try {
                const response = await sendChatMessage([
                  ...messages.map((m) => ({ role: m.role, content: m.content })),
                  { role: "user", content: text },
                ])
                setMessages((prev) => [
                  ...prev,
                  {
                    id: (Date.now() + 1).toString(),
                    role: "assistant",
                    content: response,
                    timestamp: new Date(),
                  },
                ])
                updateSuggestions(response)
              } finally {
                setIsLoading(false)
              }
            }}
            isLoading={isLoading}
            onNew={handleNewChat}
          />

          <button
            onClick={exportChat}
            className="px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-700 text-sm font-medium transition-colors"
            title="Export chat sebagai text file"
          >
            Export
          </button>

          <button
            onClick={handleNewChat}
            className="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2"
          >
            <RotateCcw className="w-4 h-4" />
            New Chat
          </button>
        </div>
      </div>
    </div>
  )
}
